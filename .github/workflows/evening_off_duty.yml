name: ğŸŒ™ ä¸‹ç­æ‰“å¡æé†’ï¼ˆå•ä¼‘ç‰ˆÂ·èŠ±é‡Œèƒ¡å“¨å¢å¼ºç‰ˆï¼‰

on:
  schedule:
    - cron: '0 11 * * *'   # UTC 11:00 = åŒ—äº¬æ—¶é—´ 19:00
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨æµ‹è¯•

jobs:
  off-duty:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒŸ å‘é€ä¸‹ç­æé†’ï¼ˆå‘¨ä¸€è‡³å‘¨å…­ï¼‰
        env:
          WECHAT_KEY: ${{ secrets.WECHAT_BOT_KEY }}
        run: |
          # === 1. è·å–æ—¥æœŸå’Œæ˜ŸæœŸ ===
          DATE_STR=$(date '+%mæœˆ%dæ—¥')
          WEEKDAY=$(date '+%u')  # 1=å‘¨ä¸€, 7=å‘¨æ—¥

          # å‘¨æ—¥ä¸æé†’ï¼ˆå•ä¼‘ï¼‰
          if [ "$WEEKDAY" = "7" ]; then
            echo "ğŸ‰ ä»Šå¤©æ˜¯å‘¨æ—¥ï¼Œä¼‘æ¯æ—¥ï¼Œä¸å‘é€æé†’ã€‚"
            exit 0
          fi

          case $WEEKDAY in
            1) CN_DAY="å‘¨ä¸€" ;;
            2) CN_DAY="å‘¨äºŒ" ;;
            3) CN_DAY="å‘¨ä¸‰" ;;
            4) CN_DAY="å‘¨å››" ;;
            5) CN_DAY="å‘¨äº”" ;;
            6) CN_DAY="å‘¨å…­" ;;
          esac

          # === 2. è·å–æ¯æ—¥ä¸€å¥ï¼ˆå¸¦å®¹é”™ï¼‰===
          quote="ä»Šå¤©ä¹Ÿè¦å¥½å¥½ä¼‘æ¯å‘€ï½"
          author="æš–å¿ƒå°åŠ©æ‰‹"

          if command -v curl >/dev/null && command -v jq >/dev/null; then
            api_resp=$(curl -s --max-time 8 "https://api.vvhan.com/api/ian" || echo '{}')
            new_quote=$(echo "$api_resp" | jq -r '.content // empty' 2>/dev/null)
            new_author=$(echo "$api_resp" | jq -r '.author // empty' 2>/dev/null)
            [ -n "$new_quote" ] && [ "$new_quote" != "null" ] && quote="$new_quote"
            [ -n "$new_author" ] && [ "$new_author" != "null" ] && author="$new_author"
          fi

          # === 3. è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ ===
          quote_safe=$(printf '%s' "$quote" | sed 's/"/\\"/g; s/\\/\\\\/g')
          author_safe=$(printf '%s' "$author" | sed 's/"/\\"/g; s/\\/\\\\/g')

          # === 4. å‘¨å…­ä¸“å±å½©è›‹ ===
          if [ "$CN_DAY" = "å‘¨å…­" ]; then
            BONUS="ğŸŒˆ <font color=\"warning\">âœ¨ å‘¨å…­åŠ ç­è¾›è‹¦å•¦ï¼</font>\\n> ğŸ’ª ä½ çš„åŠªåŠ›ï¼Œå€¼å¾—åŒå€å¥¶èŒ¶+å‘¨æœ«èººå¹³ï¼\\n> \\n> ğŸ’– æ˜å¤©å°±æ˜¯å……ç”µæ—¥ï¼Œå¥½å¥½ä¼‘æ¯ï½"
          else
            BONUS=""
          fi

          # === 5. æ„å»º Markdown å†…å®¹ ===
          CONTENT="ğŸŒ™ <font color=\"info\">â”€â”€â”€â”€â”€â”€ â° 19:00 Â· ä¸‹ç­æ—¶é—´åˆ°ï¼â”€â”€â”€â”€â”€â”€</font>\\n\\n\
ğŸ“Œ **ä»Šæ—¥**ï¼š$DATE_STRï¼ˆ$CN_DAYï¼‰\\n\
ğŸ“ **ä»»åŠ¡**ï¼š<font color=\"warning\">âœ… æ‰“å¡ + æäº¤æ—¥æŠ¥</font>\\n\\n\
ğŸ’¬ <font color=\"comment\">â€œ$quote_safeâ€</font>\\n\
> â€”â€” $author_safe\\n\\n\
$BONUS\\n\\n\
ğŸ€ <font color=\"info\">å¿«å»æ‰“å¡å§ï¼ç³»ç»Ÿåœ¨ç­‰ä½ ï½</font>\\n\\n\
[ğŸšª ç«‹å³æ‰“å¡](https://byjyedu.yuque.com/org-wiki-byjyedu-bxo6fa/bmqx33/gz2ixgatwha0u07k)\\n\\n\
@all"

          # === 6. å‘é€æ¶ˆæ¯ ===
          curl -s -X POST \
            "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=$WECHAT_KEY" \
            -H 'Content-Type: application/json' \
            -d "{\"msgtype\":\"markdown\",\"markdown\":{\"content\":\"$CONTENT\"}}" \
            >/dev/null || true

          echo "âœ… ä¸‹ç­æé†’å·²å°è¯•å‘é€ï¼ˆå‘¨æ—¥é™¤å¤–ï¼‰"
          exit 0
