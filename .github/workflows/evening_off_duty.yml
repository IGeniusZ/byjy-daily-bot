name: ğŸŒ™ ä¸‹ç­æ‰“å¡æé†’ï¼ˆå•ä¼‘ç‰ˆï¼‰

on:
  schedule:
    - cron: '0 11 * * *'   # UTC 11:00 = åŒ—äº¬æ—¶é—´ 19:00
  workflow_dispatch:        # â† è¿™è¡Œå¿…é¡»å­˜åœ¨ï¼Œä¸”ä¸èƒ½ç¼©è¿›ï¼

jobs:
  off-duty:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒŸ å‘é€èŠ±é‡Œèƒ¡å“¨ä¸‹ç­æ‰“å¡æé†’
        env:
          WECHAT_KEY:  $ {{ secrets.WECHAT_BOT_KEY }}
        run: |
          # === è·å–ä¸­æ–‡æ˜ŸæœŸ ===
          WEEKDAY= $ (date '+%u')
          case  $ WEEKDAY in
            1) CN_DAY="å‘¨ä¸€" ;;
            2) CN_DAY="å‘¨äºŒ" ;;
            3) CN_DAY="å‘¨ä¸‰" ;;
            4) CN_DAY="å‘¨å››" ;;
            5) CN_DAY="å‘¨äº”" ;;
            6) CN_DAY="å‘¨å…­" ;;
            7) CN_DAY="å‘¨æ—¥" ;;
            *) CN_DAY="æœªçŸ¥" ;;
          esac
          DATE_STR= $ (date '+%mæœˆ%dæ—¥')

          # === å®‰å…¨è·å–åè¨€ï¼ˆä¸ä¾èµ– jqï¼‰===
          quote="ä»Šå¤©ä¹Ÿè¦å¥½å¥½ä¼‘æ¯å‘€ï½"
          author="æš–å¿ƒå°åŠ©æ‰‹"
          quote_data= $ (curl -s --max-time 8 "https://api.vvhan.com/api/ian" || echo '{}')
          temp_quote= $ (printf '%s' " $ quote_data" | sed -n 's/.*"content"[[:space:]]*:[[:space:]]*"  $ [^"]* $  ".*/\1/p')
          temp_author= $ (printf '%s' " $ quote_data" | sed -n 's/.*"author"[[:space:]]*:[[:space:]]*"  $ [^"]* $  ".*/\1/p')
          [ -n " $ temp_quote" ] && quote=" $ temp_quote"
          [ -n " $ temp_author" ] && author=" $ temp_author"

          # === è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ ===
          quote_safe= $ (printf '%s' " $ quote" | sed 's/"/\\"/g; s/\\/\\\\/g')
          author_safe= $ (printf '%s' " $ author" | sed 's/"/\\"/g; s/\\/\\\\/g')

          # === å‘¨å…­å½©è›‹ ===
          if [ " $ CN_DAY" = "å‘¨å…­" ]; then
            SATURDAY_BONUS="ğŸŒˆ <font color=\"warning\">âœ¨ å‘¨å…­ä¸Šç­è¾›è‹¦å•¦ï¼</font>\n> ä½ ä»Šå¤©çš„åŠªåŠ›ï¼Œå€¼å¾—åŒå€å¥¶èŒ¶å¥–åŠ±ï¼\n> \n> ğŸ’– åˆ«å¿˜äº†ï¼šå‘¨æ—¥æ˜¯ä½ çš„å……ç”µæ—¥ï¼Œå¥½å¥½ä¼‘æ¯ï½"
          else
            SATURDAY_BONUS=""
          fi

          # === æ„å»ºå®‰å…¨ JSON ===
          JSON_BODY= $ (cat <<EOF
{
  "msgtype": "markdown",
  "markdown": {
    "content": "ğŸŒ™ <font color=\"info\">â”€â”€â”€â”€â”€â”€ â° ä¸‹ç­æ—¶é—´åˆ°ï¼â”€â”€â”€â”€â”€â”€</font>\\n\\nğŸ“Œ **ä»Šæ—¥**ï¼š $ DATE_STRï¼ˆ $ CN_DAYï¼‰\\nğŸ“ **ä»»åŠ¡**ï¼š<font color=\"warning\">âœ… æ‰“å¡ + æäº¤æ—¥æŠ¥</font>\\n\\nğŸ’¬ <font color=\"comment\">â€œ $ quote_safeâ€</font>\\n> â€”â€”  $ author_safe\\n\\n $ SATURDAY_BONUS\\n\\nğŸ€ <font color=\"info\">å¿«å»æ‰“å¡å§ï¼ç³»ç»Ÿåœ¨ç­‰ä½ ï½</font>\\n\\n[ğŸšª ç«‹å³æ‰“å¡](https://byjyedu.yuque.com/org-wiki-byjyedu-bxo6fa/bmqx33/gz2ixgatwha0u07k)\\n\\n@all"
  }
}
EOF
          )

          # === å‘é€æ¶ˆæ¯ï¼ˆå®¹é”™å¤„ç†ï¼‰===
          curl -s -X POST \
            "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key= $ WECHAT_KEY" \
            -H 'Content-Type: application/json' \
            -d " $ JSON_BODY" >/dev/null || true

          exit 0
