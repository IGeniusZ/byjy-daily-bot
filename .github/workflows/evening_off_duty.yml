name: 🌙 下班打卡提醒（单休版）

on:
  schedule:
    - cron: '0 11 * * *'   # UTC 11:00 = 北京时间 19:00
  workflow_dispatch:       # 手动触发开关

jobs:
  off-duty:
    runs-on: ubuntu-latest
    steps:
      - name: 🌟 发送花里胡哨下班打卡提醒
        env:
          WECHAT_KEY: ${{ secrets.WECHAT_BOT_KEY }}
        # 关键：移除 -e 参数，避免脚本因单个命令失败就退出
        shell: /usr/bin/bash {0}
        run: |
          # === 获取中文星期 ===
          WEEKDAY=$(date '+%u')
          case $WEEKDAY in
            1) CN_DAY="周一" ;;
            2) CN_DAY="周二" ;;
            3) CN_DAY="周三" ;;
            4) CN_DAY="周四" ;;
            5) CN_DAY="周五" ;;
            6) CN_DAY="周六" ;;
            7) CN_DAY="周日" ;;
            *) CN_DAY="未知" ;; # 增加默认值，避免变量未定义
          esac
          DATE_STR=$(date '+%m月%d日')

          # === 安全获取名言 ===
          quote="今天也要好好休息呀～"
          author="暖心小助手"
          # 先检查jq是否安装
          if command -v jq >/dev/null 2>&1; then
            # curl增加超时和容错，避免接口问题导致脚本失败
            quote_data=$(curl -s --max-time 10 --retry 2 "https://api.vvhan.com/api/ian" || true)
            # 校验JSON格式是否正确
            if echo "$quote_data" | jq empty >/dev/null 2>&1; then
              temp_quote=$(echo "$quote_data" | jq -r '.content // empty' 2>/dev/null)
              temp_author=$(echo "$quote_data" | jq -r '.author // empty' 2>/dev/null)
              # 非空且非null时才替换
              [ -n "$temp_quote" ] && [ "$temp_quote" != "null" ] && quote="$temp_quote"
              [ -n "$temp_author" ] && [ "$temp_author" != "null" ] && author="$temp_author"
            fi
          fi

          # 转义双引号和反斜杠，避免JSON语法错误
          quote_safe=$(printf '%s' "$quote" | sed -e 's/"/\\"/g' -e 's/\\/\\\\/g' 2>/dev/null)
          author_safe=$(printf '%s' "$author" | sed -e 's/"/\\"/g' -e 's/\\/\\\\/g' 2>/dev/null)

          # === 周六彩蛋 ===
          if [ "$CN_DAY" = "周六" ]; then
            SATURDAY_BONUS="🌈 <font color=\"warning\">✨ 周六上班辛苦啦！</font>\\n> 你今天的努力，值得双倍奶茶奖励！\\n> \\n> 💖 别忘了：周日是你的充电日，好好休息～"
          else
            SATURDAY_BONUS=""
          fi

          # === 构造JSON内容（避免单行过长和转义问题）===
          JSON_BODY=$(cat <<EOF
{
  "msgtype": "markdown",
  "markdown": {
    "content": "🌙 <font color=\"info\">────── ⏰ 下班时间到！──────\\n\\n📌 **今日**：$DATE_STR（$CN_DAY）\\n📍 **任务**：<font color=\"warning\">✅ 打卡 + 提交日报</font>\\n\\n💬 <font color=\"comment\">“$quote_safe”</font>\\n> —— $author_safe\\n\\n$SATURDAY_BONUS\\n\\n🎀 <font color=\"info\">快去打卡吧！系统在等你～</font>\\n\\n[🚪 立即打卡](https://byjyedu.yuque.com/org-wiki-byjyedu-bxo6fa/bmqx33/gz2ixgatwha0u07k)\\n\\n@all"
  }
}
EOF
          )

          # === 发送企微消息（核心：强制容错）===
          # 保存响应结果用于调试
          response=$(curl -s -X POST \
            "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=$WECHAT_KEY" \
            -H 'Content-Type: application/json' \
            -d "$JSON_BODY" || true)

          # 打印响应信息，方便调试
          echo "📝 企微接口响应：$response"

          # 强制返回0，确保GitHub Action标记为成功
          exit 0
