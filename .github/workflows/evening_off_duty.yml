# === è·å–ä¸­æ–‡æ˜ŸæœŸ ===
WEEKDAY=$(date '+%u')
case $WEEKDAY in
  1) CN_DAY="å‘¨ä¸€" ;;
  2) CN_DAY="å‘¨äºŒ" ;;
  3) CN_DAY="å‘¨ä¸‰" ;;
  4) CN_DAY="å‘¨å››" ;;
  5) CN_DAY="å‘¨äº”" ;;
  6) CN_DAY="å‘¨å…­" ;;
  7) CN_DAY="å‘¨æ—¥" ;;
esac
DATE_STR=$(date '+%mæœˆ%dæ—¥')

# === æ ¡éªŒ WECHAT_KEY ===
if [ -z "$WECHAT_KEY" ]; then
  echo "âŒ é”™è¯¯ï¼šç¯å¢ƒå˜é‡ WECHAT_KEY ä¸ºç©ºï¼è¯·æ£€æŸ¥ GitHub Secrets æ˜¯å¦è®¾ç½®äº† WECHAT_BOT_KEYã€‚"
  exit 1
fi

# === å®‰å…¨è·å–åè¨€ ===
quote="ä»Šå¤©ä¹Ÿè¦å¥½å¥½ä¼‘æ¯å‘€ï½"
author="æš–å¿ƒå°åŠ©æ‰‹"
if command -v jq >/dev/null; then
  quote_data=$(curl -s --max-time 10 "https://api.vvhan.com/api/ian")
  if echo "$quote_data" | jq empty >/dev/null 2>&1; then
    temp_quote=$(echo "$quote_data" | jq -r '.content // empty' 2>/dev/null)
    temp_author=$(echo "$quote_data" | jq -r '.author // empty' 2>/dev/null)
    [ -n "$temp_quote" ] && [ "$temp_quote" != "null" ] && quote="$temp_quote"
    [ -n "$temp_author" ] && [ "$temp_author" != "null" ] && author="$temp_author"  # ä¿®å¤ï¼šåŸä¸º $temp
  fi
fi

# è½¬ä¹‰åŒå¼•å·ï¼ˆé˜²æ­¢ JSON æ³¨å…¥ï¼‰
quote_safe=$(printf '%s' "$quote" | sed 's/"/\\"/g')
author_safe=$(printf '%s' "$author" | sed 's/"/\\"/g')

# === å‘¨å…­å½©è›‹ ===
if [ "$CN_DAY" = "å‘¨å…­" ]; then
  SATURDAY_BONUS="ğŸŒˆ <font color=\"warning\">âœ¨ å‘¨å…­ä¸Šç­è¾›è‹¦å•¦ï¼</font>\n> ä½ ä»Šå¤©çš„åŠªåŠ›ï¼Œå€¼å¾—åŒå€å¥¶èŒ¶å¥–åŠ±ï¼\n> \n> ğŸ’– åˆ«å¿˜äº†ï¼šå‘¨æ—¥æ˜¯ä½ çš„å……ç”µæ—¥ï¼Œå¥½å¥½ä¼‘æ¯ï½"
else
  SATURDAY_BONUS=""
fi

# === å‘é€æ¶ˆæ¯ ===
response=$(curl -s -X POST \
  "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=$WECHAT_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
    "msgtype": "markdown",
    "markdown": {
      "content": "ğŸŒ™ <font color=\"info\">â”€â”€â”€â”€â”€â”€ â° ä¸‹ç­æ—¶é—´åˆ°ï¼â”€â”€â”€â”€â”€â”€</font>\n\nğŸ“Œ **ä»Šæ—¥**ï¼š'$DATE_STR'ï¼ˆ'$CN_DAY'ï¼‰\nğŸ“ **ä»»åŠ¡**ï¼š<font color=\"warning\">âœ… æ‰“å¡ + æäº¤æ—¥æŠ¥</font>\n\nğŸ’¬ <font color=\"comment\">â€œ'$quote_safe'â€</font>\n> â€”â€” '$author_safe'\n\n'$SATURDAY_BONUS'\n\nğŸ€ <font color=\"info\">å¿«å»æ‰“å¡å§ï¼ç³»ç»Ÿåœ¨ç­‰ä½ ï½</font>\n\n[ğŸšª ç«‹å³æ‰“å¡](https://byjyedu.yuque.com/org-wiki-byjyedu-bxo6fa/bmqx33/gz2ixgatwha0u07k)\n\n@all"
    }
  }')

echo "ä¼å¾®å“åº”: $response"

# æ£€æŸ¥æ˜¯å¦å‘é€æˆåŠŸï¼ˆå¯é€‰ï¼‰
if echo "$response" | grep -q '"errcode":0'; then
  echo "âœ… æ¶ˆæ¯å‘é€æˆåŠŸï¼"
else
  echo "âš ï¸ æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Webhook Key å’Œç½‘ç»œã€‚"
  # è¿™é‡Œå¯ä»¥é€‰æ‹© exit 1 æˆ–ä¿æŒ exit 0
  # å¦‚æœå¸Œæœ› workflow å¤±è´¥ä»¥ä¾¿é€šçŸ¥ä½ ï¼Œç”¨ exit 1
  # å¦‚æœåªæ˜¯é™é»˜å¤±è´¥ï¼Œç”¨ exit 0
fi

exit 0
