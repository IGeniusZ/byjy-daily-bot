name: 🌙 下班打卡提醒（单休版）

on:
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  off-duty:
    runs-on: ubuntu-latest
    steps:
      - name: Send WeCom Reminder
        env:
          WECHAT_KEY: ${{ secrets.WECHAT_BOT_KEY }}
        run: |
          # 最简逻辑：避免一切崩溃可能
          DATE_STR=$(date '+%m月%d日')
          WEEKDAY=$(date '+%u')
          CN_DAY="周日"
          [ "$WEEKDAY" = "1" ] && CN_DAY="周一"
          [ "$WEEKDAY" = "2" ] && CN_DAY="周二"
          [ "$WEEKDAY" = "3" ] && CN_DAY="周三"
          [ "$WEEKDAY" = "4" ] && CN_DAY="周四"
          [ "$WEEKDAY" = "5" ] && CN_DAY="周五"
          [ "$WEEKDAY" = "6" ] && CN_DAY="周六"

          SATURDAY_BONUS=""
          if [ "$CN_DAY" = "周六" ]; then
            SATURDAY_BONUS="🌈 <font color=\"warning\">✨ 周六上班辛苦啦！</font>\\n> 双倍奶茶奖励！"
          fi

          # 构建 JSON（硬编码内容，确保安全）
          curl -s -X POST \
            "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=$WECHAT_KEY" \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "content": "🌙 <font color=\"info\">────── ⏰ 下班时间到！──────</font>\\n\\n📌 **今日**：'$DATE_STR'（'$CN_DAY'）\\n📍 **任务**：<font color=\"warning\">✅ 打卡 + 提交日报</font>\\n\\n💬 <font color=\"comment\">“今天也要好好休息呀～”</font>\\n> —— 暖心小助手\\n\\n'$SATURDAY_BONUS'\\n\\n🎀 <font color=\"info\">快去打卡吧！</font>\\n\\n[🚪 立即打卡](https://byjyedu.yuque.com/org-wiki-byjyedu-bxo6fa/bmqx33/gz2ixgatwha0u07k)\\n\\n@all"
              }
            }' >/dev/null || true

          echo "✅ 工作流执行完毕（无论消息是否发送成功）"
          exit 0
