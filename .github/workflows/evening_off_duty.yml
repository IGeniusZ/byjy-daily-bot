name: ğŸŒ™ ä¸‹ç­æ‰“å¡æé†’ï¼ˆå•ä¼‘ Â· åè¨€ç‰ˆï¼‰

on:
  schedule:
    # UTC 11:00 = åŒ—äº¬æ—¶é—´ 19:00ï¼Œä»…å‘¨ä¸€åˆ°å‘¨å…­
    - cron: '0 11 * * 1-6'
  workflow_dispatch:

jobs:
  off-duty:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒŸ å‘é€å¸¦åè¨€çš„ä¸‹ç­æé†’
        env:
          WECHAT_KEY: ${{ secrets.WECHAT_BOT_KEY }}
        run: |
          # === è·å–æ—¥æœŸå’Œæ˜ŸæœŸ ===
          DATE_STR=$(date '+%mæœˆ%dæ—¥')
          WEEKDAY=$(date '+%u')
          case $WEEKDAY in
            1) CN_DAY="å‘¨ä¸€" ;;
            2) CN_DAY="å‘¨äºŒ" ;;
            3) CN_DAY="å‘¨ä¸‰" ;;
            4) CN_DAY="å‘¨å››" ;;
            5) CN_DAY="å‘¨äº”" ;;
            6) CN_DAY="å‘¨å…­" ;;
          esac

          # === è·å–åè¨€ï¼ˆå…è´¹ API + å®¹é”™ï¼‰===
          quote="ä»Šå¤©ä¹Ÿè¦å¥½å¥½ä¼‘æ¯å‘€ï½"
          author="æš–å¿ƒå°åŠ©æ‰‹"

          # å°è¯•è°ƒç”¨å…è´¹ APIï¼ˆè¶…æ—¶ 5 ç§’ï¼‰
          if command -v curl >/dev/null; then
            # ä½¿ç”¨çº¯æ–‡æœ¬æ¥å£ï¼Œé¿å… JSON è§£æä¾èµ– jq
            raw_text=$(curl -s --max-time 5 "https://www.770a.cn/yiyan/?format=text" || echo "")
            if [ -n "$raw_text" ] && [ "${#raw_text}" -le 100 ]; then
              # æ ¼å¼ç¤ºä¾‹ï¼š"ç”Ÿæ´»ä¸æ­¢çœ¼å‰çš„è‹Ÿä¸”ã€‚â€”â€”é«˜æ™“æ¾"
              if echo "$raw_text" | grep -q "â€”â€”"; then
                quote=$(echo "$raw_text" | cut -d 'â€”â€”' -f 1 | xargs)
                author=$(echo "$raw_text" | cut -d 'â€”â€”' -f 2 | xargs)
              else
                quote="$raw_text"
                author="ä½šå"
              fi
            fi
          fi

          # === è½¬ä¹‰åŒå¼•å·ï¼ˆé˜²æ­¢ JSON å´©æºƒï¼‰===
          quote_safe=$(printf '%s' "$quote" | sed 's/"/\\"/g')
          author_safe=$(printf '%s' "$author" | sed 's/"/\\"/g')

          # === ä¼ä¸šå¾®ä¿¡å®˜æ–¹æ‰“å¡åœ°å€ï¼ˆ2026å¹´æœ‰æ•ˆï¼‰===
          PUNCH_URL="https://work.weixin.qq.com/wework_admin/portal/punch_in"

          # === å‘é€æ¶ˆæ¯ï¼ˆæ¢è¡Œç”¨ \nï¼Œå•å¼•å·å†…ç›´æ¥å†™ï¼‰===
          curl -s -X POST \
            "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=$WECHAT_KEY" \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "content": "ğŸŒ™ <font color=\"info\">â”€â”€â”€â”€â”€â”€ â° ä¸‹ç­æ—¶é—´åˆ°ï¼â”€â”€â”€â”€â”€â”€</font>\n\nğŸ“Œ **ä»Šæ—¥**ï¼š'$DATE_STR'ï¼ˆ'$CN_DAY'ï¼‰\nğŸ“ **ä»»åŠ¡**ï¼š<font color=\"warning\">âœ… æ‰“å¡ + æäº¤æ—¥æŠ¥</font>\n\nğŸ’¬ <font color=\"comment\">â€œ'$quote_safe'â€</font>\n> â€”â€” '$author_safe'\n\n[ğŸšª ç«‹å³æ‰“å¡]('$PUNCH_URL')\n\n@all"
              }
            }' >/dev/null || true

          exit 0
